#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="${SCRIPT_DIR}/.bible-config"

create_default_config() {
    cat >"$CONFIG_FILE" <<'EOF'
# ESV API Configuration
# Get your API token from https://api.esv.org/

# Your ESV API Token (REQUIRED)
ESV_API_TOKEN="your-api-token-here"

# Include the passage reference before the text.
INCLUDE_PASSAGE_REFERENCES=true

# Include verse numbers.
INCLUDE_VERSE_NUMBERS=true

# Include the verse number for the first verse of a chapter.
INCLUDE_FIRST_VERSE_NUMBERS=true

# Include callouts to footnotes in the text.
INCLUDE_FOOTNOTES=true

# Include footnote bodies below the text. Only works if INCLUDE_FOOTNOTES is also true.
INCLUDE_FOOTNOTE_BODY=true

# Include section headings. For example, the section heading of Matthew 5 is "The Sermon on the Mount".
INCLUDE_HEADINGS=true

# Include "(ESV)" at the end of the text.
INCLUDE_SHORT_COPYRIGHT=true

# Include a line of equal signs (====) above the beginning of each passage.
INCLUDE_PASSAGE_HORIZONTAL_LINES=false

# Include a line of underscores (____) above each section heading.
INCLUDE_HEADING_HORIZONTAL_LINES=false

# Controls the length of the line for INCLUDE_PASSAGE_HORIZONTAL_LINES and INCLUDE_HEADING_HORIZONTAL_LINES
HORIZONTAL_LINE_LENGTH=55

# Include "Selah" in certain Psalms.
INCLUDE_SELAHS=true

# Controls indentation. Must be "space" or "tab".
INDENT_USING="space"

# Controls how many indentation characters start a paragraph.
INDENT_PARAGRAPHS=2

# Controls indentation of poetry lines.
INDENT_POETRY=true

# Controls how many indentation characters are used per indentation level for poetry lines.
INDENT_POETRY_LINES=4

# Controls how many indentation characters are used for "Declares the LORD" in some of the prophets.
INDENT_DECLARES=40

# Controls how many indentation characters are used for Psalm doxologies.
INDENT_PSALM_DOXOLOGY=30

# Controls how long a line can be before it is wrapped. Use 0 for unlimited line lengths.
LINE_LENGTH=0
EOF
    echo "Created config template at: $CONFIG_FILE"
    echo "Please edit it and add your ESV_API_TOKEN"
    exit 1
}

if [ ! -f "$CONFIG_FILE" ]; then
    create_default_config
fi

source "$CONFIG_FILE"

build_query_params() {
    local params=""

    # Boolean parameters
    [ "$INCLUDE_PASSAGE_REFERENCES" == "true" ] && params="${params}&include-passage-references=true" || params="${params}&include-passage-references=false"
    [ "$INCLUDE_VERSE_NUMBERS" == "true" ] && params="${params}&include-verse-numbers=true" || params="${params}&include-verse-numbers=false"
    [ "$INCLUDE_FIRST_VERSE_NUMBERS" == "true" ] && params="${params}&include-first-verse-numbers=true" || params="${params}&include-first-verse-numbers=false"
    [ "$INCLUDE_FOOTNOTES" == "true" ] && params="${params}&include-footnotes=true" || params="${params}&include-footnotes=false"
    [ "$INCLUDE_FOOTNOTE_BODY" == "true" ] && params="${params}&include-footnote-body=true" || params="${params}&include-footnote-body=false"
    [ "$INCLUDE_HEADINGS" == "true" ] && params="${params}&include-headings=true" || params="${params}&include-headings=false"
    [ "$INCLUDE_SHORT_COPYRIGHT" == "true" ] && params="${params}&include-short-copyright=true" || params="${params}&include-short-copyright=false"
    [ "$INCLUDE_PASSAGE_HORIZONTAL_LINES" == "true" ] && params="${params}&include-passage-horizontal-lines=true" || params="${params}&include-passage-horizontal-lines=false"
    [ "$INCLUDE_HEADING_HORIZONTAL_LINES" == "true" ] && params="${params}&include-heading-horizontal-lines=true" || params="${params}&include-heading-horizontal-lines=false"
    [ "$INCLUDE_SELAHS" == "true" ] && params="${params}&include-selahs=true" || params="${params}&include-selahs=false"
    [ "$INDENT_POETRY" == "true" ] && params="${params}&indent-poetry=true" || params="${params}&indent-poetry=false"

    # String/numeric parameters
    params="${params}&horizontal-line-length=${HORIZONTAL_LINE_LENGTH}"
    params="${params}&indent-using=${INDENT_USING}"
    params="${params}&indent-paragraphs=${INDENT_PARAGRAPHS}"
    params="${params}&indent-poetry-lines=${INDENT_POETRY_LINES}"
    params="${params}&indent-declares=${INDENT_DECLARES}"
    params="${params}&indent-psalm-doxology=${INDENT_PSALM_DOXOLOGY}"
    params="${params}&line-length=${LINE_LENGTH}"

    echo "$params"
}

fetch_verse() {
    local verse="$1"
    local encoded_verse=${verse// /+}
    local query_params=$(build_query_params)

    response=$(curl -s -H "Authorization: Token $ESV_API_TOKEN" "https://api.esv.org/v3/passage/text/?q=$encoded_verse$query_params")
    if [ -n "$response" ]; then
        echo "$response" | jq -r ".passages[]?" | while IFS= read -r passage; do
            echo -e "$passage"
        done
        echo ""
    else
        echo "Error fetching: $verse"
        echo ""
    fi
}

show_help() {
    echo "ESV Bible Verse Fetcher"
    echo ""
    echo "Usage: $0 [OPTIONS] [\"verse reference\"]"
    echo ""
    echo "Options:"
    echo "  -h    Show this help message"
    echo "  -c    Show config file location"
    echo "  -e    Edit config file"
    echo ""
    echo "Examples:"
    echo "  $0 \"John 3:16\""
    echo "  $0 \"John 3:16; Romans 8:28\""
    echo "  cat verses.txt | $0"
    echo "  echo \"John 3:16\" | $0"
    echo ""
    echo "Config file: $CONFIG_FILE"
}

while getopts "hce" opt; do
    case $opt in
    h)
        show_help
        exit 0
        ;;
    c)
        echo "Config file location: $CONFIG_FILE"
        exit 0
        ;;
    e)
        ${EDITOR:-vim} "$CONFIG_FILE"
        exit 0
        ;;
    \?)
        echo "Invalid option: -$OPTARG" >&2
        exit 1
        ;;
    esac
done

shift $((OPTIND - 1))

if [ -p /dev/stdin ]; then
    while IFS= read -r line; do
        [ -n "$line" ] && fetch_verse "$line"
    done
elif [ $# -gt 0 ]; then
    fetch_verse "$1"
else
    echo "Usage: $0 \"John 3:16\""
    echo "  or: cat verses.txt | $0"
    echo "  or: echo \"John 3:16\" | $0 "
    exit 1
fi
